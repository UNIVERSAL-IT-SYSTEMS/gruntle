set dbfile [lindex $::argv 0]
set args [lreplace $::argv 0 0]

spawn moo -e $dbfile $dbfile
expect "MOO (#5): "
foreach arg $args {
	set f [open $arg]
	set data [read $f]
	close $f
	set lines [split $data \n]
	while {[llength $lines] > 0} {
		set line [lindex $lines 0]
		set lines [lreplace $lines 0 0]
		
		if [string match "" $line] {
			continue
		} elseif [string match "#*" $line] {
			continue
		} elseif {[string match "program *" $line] ||
		          [string match ";;" $line]} {
			set plines $line
			append plines "\r"
			while {! [string match "." $line]} {
				set line [lindex $lines 0]
				set lines [lreplace $lines 0 0]
				append plines $line "\r" 
			}
			send $plines
		} elseif [string match ";*" $line] {
			send $line
			send "\r"
		} else {
			puts "***** Unrecognised line: $line"
			exit 1
		}
		
		expect {
			"Unknown or malformed command." {
				puts "***** MOO compilation error"
				exit 1
			}
			"\*Aborted\*" {
				puts "***** MOO compilation error"
				exit 1
			}
			"Verb not programmed." {
				puts "***** MOO compilation error"
				exit 1
			}
			"*syntax error*" {
				puts "***** MOO compilation error"
				exit 1
			}
			"MOO (#5):"
		}
	}
}

send "quit\r"
expect "DUMPING on * finished"
wait


