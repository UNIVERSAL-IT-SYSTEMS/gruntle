<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="ts-transformer">
<style>
	:host {
		@apply(--layout-vertical);
	}

	#box {
		@apply(--layout-vertical);
		overflow: hidden;
		position: relative;
	}

	.transitions {
		transition: width 0.5s ease-in-out,
					height 0.5s ease-in-out,
					opacity 0.5s ease-in-out;
	}
		
	#new {
		position: absolute;
		top: 0;
		left: 0;
	}
</style>
<template>
	<div id="box">
		<div id="old"></div>
		<div id="new"></div>
	</div>
</template>
<script>
(function () {
"use strict";

let G = {};

Polymer({
	is: "ts-transformer",
	properties: {
		content: {
			type: Object,
			observer: "onContentChange"
		},
		animated: {
			type: Boolean,
			value: true
		},
	},
	behaviors: [
		Polymer.IronResizableBehavior
	],
	listeners: {
		"iron-resize": "onResize",

	},

	ready: function() {
		this.G = G;
		this.pendingChange = null;
		this.currentAnimation = null;
	},

	setAnimations: function(bool) {
		this.toggleClass("transitions", bool, this.$.box);
		this.toggleClass("transitions", bool, this.$.old);
		this.toggleClass("transitions", bool, this.$.new);
		Polymer.dom.flush();
	},

	replaceWithThrowaway: function() {
		let o = this.$.old.firstChild;
		if (o)
			this.$.old.removeChild(o);

		let clone = o.cloneNode(true);
		this.$.old.appendChild(clone);
	},

	onContentChange: function(n, o) {
		this.pendingChange = () => {
			this.pendingChange = null;

			console.log("swap:", n, o);

			this.setAnimations(false);
			this.$.box.style.height = this.offsetHeight + "px";
			this.$.old.style.opacity = 1.0;
			this.$.new.style.opacity = 0.0;

			if (n == null)
				n = document.createElement("DIV");
			this.$.new.appendChild(n);

			/* Hacky hacky force relayout. */
			let dummy = this.$.old.offsetHeight + this.$.new.offsetHeight;

			this.setAnimations(this.animated);
			this.$.box.style.height = n ? (n.offsetHeight + "px") : 0;
			this.$.old.style.opacity = 0.0;
			this.$.new.style.opacity = 1.0;

			let ontransitionend = () => {
				this.removeEventListener("transitionend", ontransitionend);

				let o = this.$.old.firstChild;
				if (o)
					this.$.old.removeChild(o);

				let n = this.$.new.firstChild;
				if (n)
					this.$.old.appendChild(n);

				this.setAnimations(false);
				this.$.old.style.opacity = 1.0;
				this.$.box.style.height = "";

				console.log("animation end");
				this.fire("animation-end");
			};

			if (!this.animated)
				ontransitionend();
			else {
				console.log("animation start");
				this.addEventListener("transitionend", ontransitionend);
			}
		};

		if (this.clientWidth > 0)
			this.pendingChange();
	},

	onResize: function() {
		console.log("onResize", this.clientWidth);
		this.$.old.style.width = this.$.new.style.width = this.offsetWidth + "px";

		if ((this.clientWidth > 0) && (this.pendingChange != null))
			this.pendingChange();
	},

	then: function(f) {
		let h = () => {
			if (!h)
				return;

			h = null;
			this.removeEventListener("animation-end", h);
			return f();
		};

		this.addEventListener("animation-end", h);
	},
});

})()
</script>
</dom-module>



