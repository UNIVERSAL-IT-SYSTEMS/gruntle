<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="ts-document.html">
<link rel="import" href="ts-editor.html">
<link rel="import" href="ts-login.html">
<link rel="import" href="ts-parser.html">
<link rel="import" href="ts-transcript.html">

<dom-module id="ts-application">
<template>
	<style>

	:host {
		@apply(--layout-fit);
		display: block;
		background-color: var(--paper-blue-grey-100);
	}

	#loading, #login {
		@apply(--layout-fit);
		@apply(--layout-center-center);
		@apply(--layout-vertical);
	}

	#game {
		min-height: 100vh;
		overflow-y: scroll;
		height: 0;
	}

	#game ts-transcript {
		@apply(--shadow-elevation-4dp);
		max-width: 800px;
		margin-left: auto;
		margin-right: auto;
		background-color: white;
		padding-left: 2em;
		padding-right: 2em;
	}

	#game > paper-fab-speed-dial {
		position: fixed;
		top: 20px;
		right: 20px;
	}

	#game > paper-fab-speed-dial paper-fab {
		--paper-fab-background: var(--paper-light-blue-300);
		--paper-fab-keyboard-focus-background: var(--paper-light-blue-500);
	}

	#talkboxContainer {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
	}

	#talkbox {
		background-color: rgba(255, 255, 255, 0.9);
		max-width: 790px;
		margin-left: auto;
		margin-right: auto;
		padding-left: 2em;
		padding-right: 2em;
	};

	#talkbox --paper-input-container-input: {
		font-size: 140%;
	};

	#editorDialogue {
		width: 90%;
		height: 90%;
	}

	</style>

	<ts-document id="doc"
		hub-document="0ByWQADzU1i2wa3N1VmVweS1EOE0"
		world-document="0ByWQADzU1i2wampHaEZ0OEJLOVk"
		on-player-visible="onDocumentConnected"
		on-auth-success="onDocumentAuthSuccess"
		on-auth-failure="onDocumentAuthFailure"
		on-connection-error="onServerError"
		on-disconnected="onDocumentDisconnected"
		on-arrivals-departures="onArrivalsDepartures"
		>
	</ts-document>

	<ts-parser id="parser"></ts-parser>

	<paper-dialog id="editorDialogue" modal="true">
		<ts-editor id="editor"></ts-editor>
	</paper-dialog>

	<iron-pages id="page" selected="0">
		<div id="loading">
			<paper-spinner active></paper-spinner>
		</div>

		<div id="game">
			<paper-fab-speed-dial direction="bottom">
				<paper-fab icon="menu" class="dropdown-trigger"></paper-fab>
				<div class="dropdown-content">
					<paper-fab mini icon="settings" id="settingsButton"></paper-fab>
					<paper-fab mini hidden="{{!author}}" icon="create"
						on-click="onEditButton"></paper-fab>
					<paper-fab mini hidden="{{!author}}" icon="explore"></paper-fab>
				</div>
			</paper-fab-speed-dial>
			<ts-transcript id="transcript">
			</ts-transcript>
			<div id="talkboxContainer">
				<paper-input id="talkbox"
					label="Type here to talk"
					on-keydown="onTalkBoxKeydown"
					autofocus
					always-float-label
					>
				</paper-input>
			</div>
		</div>

		<ts-login id="login"
			on-click="doExplicitLogin"
			></ts-login>
	</iron-pages>
</template>
<script>
(function () {
"use strict";

let $ = null;
let hub = null;
let worldConfig = null;
let playerState = null;
let rooms = null;
let player = null;

class Player {
	constructor() {
		this.cachedLocation = null;
		this.cachedLocationName = null;
	}

	get location() {
		let name = playerState.get("location");
		if (!name)
			return null;

		if (!this.cachedLocation || (this.cachedLocationName != name)) {
			this.cachedLocationName = name;
			this.cachedLocation = new Room(name);
		}
		return this.cachedLocation;
	}

	set location(v) {
		this.cachedLocationName = v.id;
		this.cachedLocation = v;
		playerState.set("location", v.id);
	}

	get name() {
		return playerState.get("useName");
	}

	set name(v) {
		playerState.set("useName", v);
	}

	get id() {
		return $.doc.myself.userId;
	}
}

function postEvent(room, kind, player, text) {
	let e = {
		kind: kind,
		player: player ? player.id : null,
		text: text,
		time: $.doc.hub.getModel().serverRevision
	};

	if (room.log.length > 20)
		room.log.removeRange(0, room.log.length-20);
	room.log.push(e);

	console.log(`${e.time}: ${kind} in ${room.title}: ${player ? player.name : 'null'}: ${text}`);
}

class Room {
	constructor(id) {
		this.id = id;
		this.node = rooms.get(id);
		this.log = ensureList($.doc.hub, hub, this.id);
	}

	get model() {
		return $.doc.world.getModel();
	}

	get title() {
		return this.node.get("title");
	}

	get text() {
		return this.node.get("text");
	}
	
	get pendingTitle() {
		return this._ensurePending("title", "pendingTitle");
	}

	get pendingText() {
		return this._ensurePending("text", "pendingText");
	}
	
	_ensurePending(original, pending) {
		let p = this.node.get(pending);
		if (!p) {
			p = $.doc.world.getModel().createString();
			this.node.set(pending, p);

			let s = this.node.get(original).getText();
			p.setText(s);
		}
		return p;
	}

	_commitPending(original, pending) {
		let p = this.node.get(pending);
		if (p)
			this.node.get(original).setText(p.getText());
	}

	commitPending() {
		this._commitPending("title", "pendingTitle");
		this._commitPending("text", "pendingText");
	}

	_revertPending(original, pending) {
		let p = this.node.get(pending);
		if (p)
			p.setText(this.node.get(original).getText());
	}

	revertPending() {
		this._revertPending("title", "pendingTitle");
		this._revertPending("text", "pendingText");
	}

	tell(player, text) {
		postEvent(this, "tell", player, text);
	}

	tellOthers(player, text) {
		postEvent(this, "tellOthers", player, text);
	}

	broadcast(text) {
		postEvent(this, "broadcast", null, text);
	}
}

function ensureMap(doc, node, name) {
	let v = node.get(name);
	if (!v) {
		v = doc.getModel().createMap();
		node.set(name, v);
	}
	return v
}

function ensureList(doc, node, name) {
	let v = node.get(name);
	if (!v) {
		v = doc.getModel().createList();
		node.set(name, v);
	}
	return v
}

function roomEventListener(e) {
	let values = e.values.slice(0);
	values.sort(
		(a, b) => a.time - b.time
	);

	for (let e of values) {
		switch (e.kind) {
			case "tellOthers":
				if (e.player != player.id)
					$.transcript.append(e);
				break;

			case "tell":
				if (e.player == player.id)
					$.transcript.append(e);
				break;

			case "broadcast":
				$.transcript.append(e);
				break;

			default:
				console.log("unhandled event", e);
				break;
		}
	}
}

Polymer({
	is: "ts-application",

	ready: function() {
		$ = this.$;
		this.author = false;

		this.doImplicitLogin();
	},

	doImplicitLogin: function() {
		$.page.selected = 0;
		$.doc.authenticate(true);
	},

	doExplicitLogin: function() {
		$.page.selected = 0;
		$.doc.authenticate(false);
	},

	onServerError: function(e) {
		console.log("server error!", e);
	},

	onDocumentAuthSuccess: function() {
		$.doc.connect();
	},

	onDocumentAuthFailure: function(e, f) {
		console.log(e, f);
		$.page.selected = 2;
	},

	onDocumentConnected: function() {
		console.log("connected");

		hub = ensureMap($.doc.hub, $.doc.hub.getModel().getRoot(), $.doc.worldDocument);
		playerState = ensureMap($.doc.hub, hub, $.doc.myself.userId);

		worldConfig = $.doc.worldRoot.get("config");
		rooms = $.doc.worldRoot.get("rooms");

		player = new Player;
		if (!player.name)
			player.name = $.doc.myself.displayName;

		if (!player.location)
		{
			let entrypoint = this.worldConfig.get("entrypoint");
			player.location = new Room(entrypoint);
		}

		this._onPlayerLocationChanged(
			{
				oldValue: null,
				newValue: player.location.id
			}
		);

		player.location.tellOthers(player, `${player.name} teleports in.`);

		playerState.addEventListener(
			gapi.drive.realtime.EventType.VALUE_CHANGED,
			(e) => {
				if (e.isLocal || (e.oldValue == e.newValue))
					return;

				switch (e.property) {
					case "location": return this._onPlayerLocationChanged(e);
				}
			}
		);

		this.author = !$.doc.world.getModel.isReadOnly;
		$.page.selected = 1;
	},

	_onPlayerLocationChanged: function(e) {
		let oldRoom = e.oldValue ? new Room(e.oldValue) : null;
		let newRoom = player.location;

		/* If this is a bad room name, put the player back at the entrypoint. */

		if (!newRoom.node) {
			if (oldRoom) {
				oldRoom.tellOthers(player, `${player.name} shimmers weirdly and vanishes. That can't be right.`);
				oldRoom.tell(player, `The world shimmers weirdly around you and dissolves. That can't be right.`);
			}

			let entrypoint = worldConfig.get("entrypoint");
			oldRoom = null;
			newRoom = player.location = new Room(entrypoint);
		}

		/* Parse the room text and update the transcript. */

		let parsed = $.parser.parse(newRoom.text, player.name);
		parsed.onAction = (action) => this.onAction(action);
		$.transcript.newRoom(newRoom.title, parsed.dom, "");

		/* Watch for events in this room. */

		if (oldRoom)
			hub.get(oldRoom.id).removeEventListener(
				gapi.drive.realtime.EventType.VALUES_ADDED,
				roomEventListener);

		hub.get(newRoom.id).addEventListener(
			gapi.drive.realtime.EventType.VALUES_ADDED,
			roomEventListener);
	},

	onEditButton: function() {
		$.editor.playerName = player.name;
		$.editor.room = player.location;
		$.editorDialogue.open();
	},

	onTalkBoxKeydown: function(e) {
		if (e.keyCode == 13) {
			let s = $.talkbox.value;
			player.location.tellOthers(player, `${player.name} says, "${s}"`);
			player.location.tell(player, `You say "${s}"`);
			$.talkbox.value = "";
		}
	},

	onDocumentDisconnected: function() {
		console.log("disconnected");
	},

	onArrivalsDepartures: function(e, changes) {
		console.log("arriving/departing", changes);
	},

	onAction: function(action) {
	},
});


})();
</script>
</dom-module>
