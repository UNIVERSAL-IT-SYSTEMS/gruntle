<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="ts-document.html">
<link rel="import" href="ts-editor.html">
<link rel="import" href="ts-globals.html">
<link rel="import" href="ts-login.html">
<link rel="import" href="ts-map.html">
<link rel="import" href="ts-roomstore.html">
<link rel="import" href="ts-transcript.html">

<dom-module id="ts-application">
<template>
	<style>

	:host {
		@apply(--layout-fit);
		display: block;
		background-color: var(--paper-blue-grey-100);
	}

	#loading, #login {
		@apply(--layout-fit);
		@apply(--layout-center-center);
		@apply(--layout-vertical);
	}

	#game {
		min-height: 100vh;
		overflow-y: scroll;
		height: 0;
	}

	#game ts-transcript {
		@apply(--shadow-elevation-4dp);
		max-width: 800px;
		margin-left: auto;
		margin-right: auto;
		background-color: white;
		padding-left: 2em;
		padding-right: 2em;
	}

	#game > paper-fab-speed-dial {
		position: fixed;
		top: 20px;
		right: 20px;
	}

	#game > paper-fab-speed-dial paper-fab {
		--paper-fab-background: var(--paper-light-blue-300);
		--paper-fab-keyboard-focus-background: var(--paper-light-blue-500);
	}

	#talkboxContainer {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
	}

	#talkbox {
		background-color: rgba(255, 255, 255, 0.9);
		max-width: 790px;
		margin-left: auto;
		margin-right: auto;
		padding-left: 2em;
		padding-right: 2em;
	}

	#talkbox --paper-input-container-input: {
		font-size: 140%;
	}

	#editorDialogue, #mapDialogue {
		position: fixed;
		left: 1em;
		top: 2em;
		right: 1em;
		bottom: 2em;
	}

	</style>

	<ts-document id="doc"
		hub-document="0ByWQADzU1i2wa3N1VmVweS1EOE0"
		world-document="0ByWQADzU1i2wampHaEZ0OEJLOVk"
		on-player-visible="onDocumentConnected"
		on-auth-success="onDocumentAuthSuccess"
		on-auth-failure="onDocumentAuthFailure"
		on-connection-error="onServerError"
		on-disconnected="onDocumentDisconnected"
		on-arrivals-departures="onArrivalsDepartures"
		>
	</ts-document>

	<ts-globals id="globals"></ts-globals>
	<ts-roomstore id="roomstore"
		on-current-room-changed="onCurrentRoomChanged"
		on-hyperspace="onHyperspaceJump"
		></ts-roomstore>

	<paper-dialog id="editorDialogue" modal="true">
		<ts-editor id="editor"></ts-editor>
	</paper-dialog>

	<paper-dialog id="mapDialogue" modal="true">
		<ts-map id="map"></ts-map>
	</paper-dialog>

	<iron-pages id="page" selected="0">
		<div id="loading">
			<paper-spinner active></paper-spinner>
		</div>

		<div id="game">
			<paper-fab-speed-dial direction="bottom">
				<paper-fab icon="menu" class="dropdown-trigger"></paper-fab>
				<div class="dropdown-content">
					<paper-fab mini icon="settings" id="settingsButton"></paper-fab>
					<paper-fab mini hidden="{{!author}}" icon="create"
						on-click="onEditButton"></paper-fab>
					<paper-fab mini hidden="{{!author}}" icon="explore"
						on-click="onMapButton"></paper-fab>
				</div>
			</paper-fab-speed-dial>
			<ts-transcript id="transcript">
			</ts-transcript>
			<div id="talkboxContainer">
				<paper-input id="talkbox"
					label="Type here to talk"
					on-keydown="onTalkBoxKeydown"
					autofocus
					always-float-label
					>
				</paper-input>
			</div>
		</div>

		<ts-login id="login"
			on-click="doExplicitLogin"
			></ts-login>
	</iron-pages>
</template>
<script>
(function () {
"use strict";

let $ = null;
let G = null;

class Player {
	constructor() {
	}

	get location() {
		let name = G.playerState.get("location");
		if (!name)
			return null;

		return $.roomstore.get(name);
	}

	set location(v) {
		G.playerState.set("location", v.id);
	}

	get name() {
		return G.playerState.get("useName");
	}

	set name(v) {
		G.playerState.set("useName", v);
	}

	get id() {
		return $.doc.myself.userId;
	}
}

function ensureMap(doc, node, name) {
	let v = node.get(name);
	if (!v) {
		v = doc.getModel().createMap();
		node.set(name, v);
	}
	return v
}

function roomEventListener(e) {
	let values = e.values.slice(0);
	values.sort(
		(a, b) => a.time - b.time
	);

	for (let e of values) {
		switch (e.kind) {
			case "tellOthers":
				if (e.player != G.player.id)
					$.transcript.append(e);
				break;

			case "tell":
				if (e.player == G.player.id)
					$.transcript.append(e);
				break;

			case "broadcast":
				$.transcript.append(e);
				break;

			default:
				console.log("unhandled event", e);
				break;
		}
	}
}

Polymer({
	is: "ts-application",

	ready: function() {
		$ = this.$;
		G = $.globals.G;
		this.author = false;

		this.doImplicitLogin();
	},

	doImplicitLogin: function() {
		$.page.selected = 0;
		$.doc.authenticate(true);
	},

	doExplicitLogin: function() {
		$.page.selected = 0;
		$.doc.authenticate(false);
	},

	onServerError: function(e) {
		console.log("server error!", e);
	},

	onDocumentAuthSuccess: function() {
		$.doc.connect();
	},

	onDocumentAuthFailure: function(e, f) {
		console.log(e, f);
		$.page.selected = 2;
	},

	onDocumentConnected: function() {
		console.log("connected");

		G.hubDoc = $.doc.hub;
		G.hub = ensureMap($.doc.hub, $.doc.hub.getModel().getRoot(), $.doc.worldDocument);
		G.playerState = ensureMap(G.hubDoc, G.hub, $.doc.myself.userId);

		G.worldDoc = $.doc.world;
		G.worldConfig = $.doc.worldRoot.get("config");

		G.worldRooms = $.doc.worldRoot.get("rooms");
		$.roomstore.startWatching();

		G.player = new Player;
		if (!G.player.name)
			G.player.name = $.doc.myself.displayName;

		if (!G.player.location)
		{
			let entrypoint = G.worldConfig.get("entrypoint");
			G.player.location = $.roomstore.get(entrypoint);
		}

		this._onPlayerLocationChanged(
			{
				oldValue: null,
				newValue: G.player.location.id
			}
		);

		G.player.location.tellOthers(G.player, `${G.player.name} teleports in.`);

		G.playerState.addEventListener(
			gapi.drive.realtime.EventType.VALUE_CHANGED,
			(e) => {
				if (e.oldValue == e.newValue)
					return;

				switch (e.property) {
					case "location": return this._onPlayerLocationChanged(e);
				}
			}
		);

		this.author = !$.doc.world.getModel.isReadOnly;
		$.page.selected = 1;
	},

	_onPlayerLocationChanged: function(e) {
		let oldRoom = e.oldValue ? $.roomstore.get(e.oldValue) : null;
		if (oldRoom)
			G.hub.get(oldRoom.id).removeEventListener(
				gapi.drive.realtime.EventType.VALUES_ADDED,
				roomEventListener);

		let newRoom = G.player.location;

		/* If this is a bad room name, put the player back at the entrypoint. */

		if (!newRoom.node) {
			this.onHyperspaceJump(null, oldRoom);
			return;
		}

		$.transcript.newRoom(newRoom);

		G.hub.get(newRoom.id).addEventListener(
			gapi.drive.realtime.EventType.VALUES_ADDED,
			roomEventListener);
	},

	onEditButton: function() {
		$.editor.room = G.player.location;
		$.editorDialogue.open();
	},

	onMapButton: function() {
		$.mapDialogue.open();
	},

	onTalkBoxKeydown: function(e) {
		if (e.keyCode == 13) {
			let s = $.talkbox.value;
			G.player.location.tellOthers(G.player, `${G.player.name} says, "${s}"`);
			G.player.location.tell(G.player, `You say "${s}"`);
			$.talkbox.value = "";
		}
	},

	onDocumentDisconnected: function() {
		console.log("disconnected");
	},

	onArrivalsDepartures: function(e, changes) {
		console.log("arriving/departing", changes);
	},

	onAction: function(action) {
	},

	onCurrentRoomChanged: function() {
		$.transcript.updateRoom(G.player.location);
	},

	onHyperspaceJump: function(e, oldRoom) {
		if (oldRoom) {
			oldRoom.tellOthers(G.player, `${G.player.name} shimmers weirdly and vanishes. That can't be right.`);
			oldRoom.tell(G.player, `The world shimmers weirdly around you and dissolves. That can't be right.`);
		}

		let entrypoint = G.worldConfig.get("entrypoint");
		G.player.location = $.roomstore.get(entrypoint);
	},
});


})();
</script>
</dom-module>
