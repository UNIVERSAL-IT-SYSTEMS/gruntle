<script src="../bower_components/lodash/lodash.min.js"></script>
<script src="../bower_components/graphlib/dist/graphlib.core.js"></script>
<script src="../bower_components/dagre/dist/dagre.core.min.js"></script>
<script src="../bower_components/d3/d3.min.js"></script>
<script src="../bower_components/dagre-d3/dist/dagre-d3.core.min.js"></script>
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="ts-globals.html">

<style>
	svg#map .node rect {
		stroke: #333;
		fill: #fff;
	}

	svg#map .node.fake rect {
		fill: #f88;
	}

	svg#map .node.entrypoint rect {
		fill: #ff8;
	}

	svg#map .edgePath path {
		stroke: #333;
		stroke-width: 1.5px;
	}
</style>

<dom-module id="ts-map">
<style>
	:host {
		@apply(--layout-fit);
		@apply(--layout-vertical);
	}

	#mapContainer {
		@apply(--layout-flex);
		overflow: hidden;
	}

	#map {
		width: 100vw;
		height: 100vh;
	}

</style>

<template>
	<ts-globals id="globals"></ts-globals>

	<h2>Map</h2>
	<paper-material id="mapContainer">
		<svg id="map"><g/></svg>
	</paper-material>

	<div class="buttons">
		<paper-button dialog-dismiss>Close</paper-button>
	</div>
</template>
<script>
(function () {
"use strict";

let G;

Polymer({
	is: "ts-map",
	properties: {
		opened: {
			type: Boolean,
			observer: "onOpenClose"
		},
	},
	behaviors: [
		Polymer.IronResizableBehavior
	],
	listeners: {
		"iron-resize": "onResize"
	},

	ready: function() {
		G = this.$.globals.G;
		this.oldWidth = 0;
		this.drawn = false;
	},

	updateMap: function() {
		/* Only update the map if we're visible. */

		if (this.$.mapContainer.offsetWidth == 0)
			return;

		/* Construct the map from the room data. */
		
		let rooms = G.rooms.getAll();
		let nodes = [];
		let edges = [];

		for (let r of rooms) {
			let parsed = r.parse();
			nodes.push(r);

			for (let exit of parsed.exits) {
				if (!G.rooms.get(exit).exists)
					nodes.push(
						{
							id: exit,
							fake: true
						}
					);

				edges.push(
					{
						from: r.id,
						to: exit
					}
				);
			}
		}

		/* Remove the old graph. */

		d3.select(this.$.map).select("g *").remove();

		/* Now render the graph to the canvas. */

		let svg = d3.select(this.$.map);
		let inner = svg.select("g");

		let g = new dagreD3.graphlib.Graph().setGraph({});

		for (let room of nodes) {
			let classes = [];
			if (room.fake)
				classes.push("fake");
			if (room.id == G.world.data.settings.entrypoint)
				classes.push("entrypoint");

			g.setNode(room.id,
				{
					label: room.id,
					class: classes.join(" "),
				}
			);
		}

		for (let edge of edges) {
			g.setEdge(edge.from, edge.to,
				{
					lineInterpolate: "basis"
				}
			);
		}

		/* Actually render it. */

		(new dagreD3.render())(inner, g);

		/* Add click behaviours. */

		let onClick = (d, i) => this.fire("edit-request", d);
		svg.selectAll(".node rect").on("click", onClick);
		svg.selectAll(".node tspan").on("click", onClick);

		/* If this is the first time the map has been shown, set up the zoom/drag
		 * behaviours and centre it. */

		if (!this.drawn) {
			let zoom = d3.behavior.zoom().on("zoom",
				() => inner.attr(
					"transform", "translate(" + d3.event.translate + ")" +
						"scale(" + d3.event.scale + ")")
			);
			svg.call(zoom);

			let scale = 0.75;
			let width = this.$.mapContainer.offsetWidth;
			let height = this.$.mapContainer.offsetHeight;
			zoom
				.translate([
					(width - g.graph().width * scale) / 2,
					(height - g.graph().height * scale) / 2
				])
				.scale(scale)
				.event(svg);
		}

		this.drawn = true;
	},

	onResize: function(e) {
		let width = this.$.mapContainer.offsetWidth;
		if ((width > 0) && (this.oldWidth == 0))
			this.onOpen();
		else if ((width == 0) && (this.oldWidth > 0))
			this.onClose();
		this.oldWidth = width;
	},

	onOpen: function() {
		this.updateMap();
	},

	onClose: function() {
		console.log("onclose");
		d3.select(this.$.map).on(".zoom", null);
		this.drawn = false;
	},
});


})();
</script>
</dom-module>


