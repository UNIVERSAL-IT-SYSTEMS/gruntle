<link rel="import" href="ts-globals.html">

<dom-module id="ts-hub">
<template>
	<style>
	  :host {
		display: none;
	  }
	</style>

	<ts-globals id="globals"></ts-globals>
</template>
<script>
(function () {
"use strict";

let G;

function getMyself(rt) {
	for (let c of rt.getCollaborators())
		if (c.isMe)
			return c;
	throw "current player not a collaborator!";
}

Polymer({
	is: "ts-hub",
	properties: {
		hubId: String,
		worldId: String,
	},

	ready: function() {
		G = this.$.globals.G;

		this.people = new Map();
	},

	connect: function() {
		let p;

		switch (this.hubId) {
			case "private":
			case null:
			case undefined:
				console.log("using in-memory hub");
				p = new Promise(
					(pass, fail) => {
						/* gapi does not return real promises */
						return gapi.drive.realtime.newInMemoryDocument(
							pass,
							null,
							fail
						);
					}
				);
				break;

			case "this":
				this.hubId = this.worldId;
				/* fall through */

			default:
				console.log("using shared hub");
				p = new Promise(
					(pass, fail) => {
						/* gapi does not return real promises */
						return gapi.drive.realtime.load(
							this.hubId,
							pass,
							null,
							fail
						);
					}
				);
				break;
		}

		return p.then(
			(rt) => {
				this.hubRT = rt;
				console.log("hub revision:", this.hubRT.getModel().serverRevision);

				this.myself = getMyself(rt);

				let hubs = G.ensureMap(rt, rt.getModel().getRoot(), "hub");
				this.hubNode = G.ensureMap(rt, hubs, this.worldId);

				this.roomsNode = G.ensureMap(rt, this.hubNode, "rooms");

				let playersNode = G.ensureMap(rt, this.hubNode, "player");
				this.playerNode = G.ensureMap(rt, playersNode, this.myself.userId);
				
				this.playersHeartbeatNode = G.ensureMap(rt, this.hubNode, "playersHeartbeat");
				this.playersHeartbeatNode.addEventListener(
					gapi.drive.realtime.EventType.VALUE_CHANGED,
					(e) => {
						if (e.oldValue == e.newValue)
							return;

						console.log("player", e.property, "changed");
					}
				);
			}
		);
	},
});

})();
</script>
</dom-module>

